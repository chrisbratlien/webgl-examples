<!DOCTYPE html>
<html>
<body>

  <img id="scream" src="img_the_scream.jpg" alt="The Scream">
  <canvas id="myCanvas">
  Your browser does not support the HTML5 canvas tag.
</canvas>


  <img class="lindt-jpg" src="lindt.jpg" alt="Chocolate">
  <canvas class="canvas-chocolate">
  Your browser does not support the HTML5 canvas tag.
  </canvas>

<script type="module">
  //import scalar, {lerp} from './scalar.js';
  import scalar, {lerp, remap, invlerp} from './scalar.js';
  window.lerp = lerp;
  window.invlerp = invlerp;
  window.remap = remap;
  window.scalar = scalar;
  //window.scalar = scalar;
</script>

<script>
function toXY(i,w,h) {
  let x = i % w;
  let y = Math.floor(i / w);
  return [x,y];
}

function followX(x,y,t_x,t_y,v_x,v_y,r,g,b,a,uniform) {
  return [v_x, v_x, v_x, a];
}
function followY(x,y,t_x,t_y,v_x,v_y,r,g,b,a,uniform) {
  return [v_y, v_y, v_y, a];
}

function transformColor(x,y,t_x,t_y,v_x,v_y,r,g,b,a,uniform) {
    let tv = (v_x + v_y) * 0.5;

    //r *= t_x * t_y;
    //g *= t_x * t_y;
    r *= Math.sin(t_x * Math.PI) * Math.cos(t_y * Math.PI);
    //g = r;
    b = r;

    //r *= (1-t_y);
    //g *= (1-t_x);
    //b *= (1-t_y);// * t_y;
    //b *= t_x * t_y;

    //r = v_x;
    //g = tv;
    //g = tv;
    //b = tv;

  return [r,g,b,a];
}

function process(c,img,transformer) {
  var ctx = c.getContext("2d");
  c.width = img.width;
  c.height = img.height;
  ctx.drawImage(img, 0, 0);
  var imgData = ctx.getImageData(0, 0, c.width, c.height);
  console.log(c.width,c.height);
  // invert colors
  var i,pixelIdx = 0;
  for (i = 0; i < imgData.data.length; i += 4) {
    let pixelIdx = Math.floor(i / 4);
    let [x,y] = toXY(pixelIdx, c.width, c.height);
    //let t = lerp()
    //scalar.remap(0,277,0,1,276)
    let t_x = invlerp(0,c.width,x);
    let t_y = invlerp(0,c.height,y);
    let v_x =  remap(0,c.width,0,255,x);
    let v_y =  remap(0,c.height,0,255,y);
    //console.log('i',i,'pixelIdx',pixelIdx,'x',x,'y',y,'t_x',t_x,'v_x',v_x);

    let [r,g,b,a] = transformer(
      x,
      y,
      t_x, //x remapped from 0 to 1
      t_y, //y remapped from 0 to 1
      v_x, //x remapped from 0 to 255
      v_y, //y remapped from 0 to 255
      imgData.data[i+0],
      imgData.data[i+1],
      imgData.data[i+2],
      imgData.data[i+3],
      {
        width: c.width,
        height: c.height
      }
    );

    imgData.data[i+0] = r;
    imgData.data[i+1] = g;
    imgData.data[i+2] = b;
    imgData.data[i+3] = a;
    pixelIdx += 1;
  }
  ctx.putImageData(imgData, 0, 0);
}

var c = document.getElementById("myCanvas");
var img = document.getElementById("scream");

var c2 = document.querySelector('.canvas-chocolate');
var img2 = document.querySelector('.lindt-jpg');

setTimeout(function() { 
  process(c,img,transformColor) 
  process(c,img,transformColor) 
  process(c2,img2,followY);
},1000);

</script>

</body>
</html>

